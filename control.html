<!--
==================================================================================
RESTRICTED ACCESS CONTROL PANEL - AUTHORIZED PERSONNEL ONLY
==================================================================================

‚ö†Ô∏è WARNING: UNAUTHORIZED ACCESS IS STRICTLY PROHIBITED ‚ö†Ô∏è

This is a restricted administrative control panel for the Interactive Probability
Learning system. Access to this page requires proper authorization and is logged
for security purposes.

REPOSITORY VERIFICATION REQUIRED:
Only authorized users connected to the official repository at:
https://github.com/chat7689/interactive-probability-learning

PROTECTED UNDER COPYRIGHT LAW - ALL RIGHTS RESERVED
==================================================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>System Control Panel</title>
    <link rel="stylesheet" href="css/styles.css?v=2025-control">

    <!-- Copy Protection -->
    <style>
      body {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        color: #fff;
      }

      .control-container {
        max-width: 800px;
        margin: 50px auto;
        padding: 30px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
      }

      .auth-screen {
        text-align: center;
        padding: 50px 20px;
      }

      .auth-screen h1 {
        color: #e74c3c;
        margin-bottom: 20px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      }

      .passcode-input {
        padding: 15px 20px;
        font-size: 18px;
        border: 2px solid #555;
        border-radius: 10px;
        background: rgba(0, 0, 0, 0.3);
        color: #fff;
        margin: 20px 10px;
        width: 300px;
        text-align: center;
      }

      .auth-btn {
        padding: 15px 30px;
        font-size: 16px;
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        margin: 10px;
        transition: all 0.3s ease;
      }

      .auth-btn:hover {
        background: linear-gradient(135deg, #c0392b, #a93226);
        transform: translateY(-2px);
      }

      .admin-panel {
        display: none;
      }

      .admin-header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid rgba(255, 255, 255, 0.2);
      }

      .user-list {
        display: grid;
        gap: 15px;
        max-height: 400px;
        overflow-y: auto;
        padding: 20px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
      }

      .user-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .user-info {
        flex-grow: 1;
      }

      .username {
        font-weight: bold;
        font-size: 16px;
      }

      .user-stats {
        font-size: 12px;
        color: #bbb;
        margin-top: 5px;
      }

      .admin-toggle {
        position: relative;
        width: 60px;
        height: 30px;
        background: #555;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .admin-toggle.active {
        background: #27ae60;
      }

      .toggle-slider {
        position: absolute;
        top: 3px;
        left: 3px;
        width: 24px;
        height: 24px;
        background: white;
        border-radius: 50%;
        transition: all 0.3s ease;
      }

      .admin-toggle.active .toggle-slider {
        left: 33px;
      }

      .back-btn {
        position: fixed;
        top: 20px;
        left: 20px;
        padding: 10px 20px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
      }

      .error-msg {
        color: #e74c3c;
        margin-top: 15px;
        font-weight: bold;
      }

      .warning-banner {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        padding: 15px;
        text-align: center;
        font-weight: bold;
        margin-bottom: 20px;
        border-radius: 10px;
      }

      .admin-section {
        margin: 30px 0;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .admin-section h3 {
        color: #3498db;
        margin-bottom: 20px;
        text-align: center;
      }

      .multiplier-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 15px;
      }

      .multiplier-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        gap: 10px;
      }

      .multiplier-item label {
        font-weight: bold;
        flex: 1;
      }

      .multiplier-item input {
        width: 80px;
        padding: 8px;
        border: 1px solid #555;
        border-radius: 5px;
        background: rgba(0, 0, 0, 0.3);
        color: #fff;
        text-align: center;
      }

      .multiplier-item button {
        padding: 8px 15px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      .multiplier-item button:hover {
        background: #2980b9;
      }

      .tax-controls {
        text-align: center;
        padding: 20px;
      }

      .tax-btn {
        padding: 15px 25px;
        margin: 10px;
        font-size: 16px;
        font-weight: bold;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .tax-btn:nth-child(2) {
        background: linear-gradient(135deg, #f39c12, #e67e22);
        color: white;
      }

      .tax-btn:nth-child(3) {
        background: linear-gradient(135deg, #e67e22, #d35400);
        color: white;
      }

      .tax-btn:nth-child(4) {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
      }

      .tax-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .tax-status {
        margin-top: 15px;
        padding: 10px;
        border-radius: 5px;
        font-weight: bold;
        text-align: center;
      }

      .tax-status.success {
        background: rgba(39, 174, 96, 0.2);
        color: #27ae60;
        border: 1px solid #27ae60;
      }

      .tax-status.error {
        background: rgba(231, 76, 60, 0.2);
        color: #e74c3c;
        border: 1px solid #e74c3c;
      }

      .panel-controls {
        display: flex;
        justify-content: center;
        gap: 20px;
        flex-wrap: wrap;
      }

      .refresh-btn {
        padding: 15px 25px;
        font-size: 16px;
        font-weight: bold;
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .refresh-btn:hover {
        background: linear-gradient(135deg, #2980b9, #1f5f8b);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }
    </style>
</head>
<body>
    <a href="index.html" class="back-btn">‚Üê Back to Chat</a>

    <div class="control-container">
        <!-- Authentication Screen -->
        <div id="authScreen" class="auth-screen">
            <div class="warning-banner">
                üîí RESTRICTED ACCESS - AUTHORIZATION REQUIRED
            </div>
            <h1>üõ°Ô∏è System Control Panel</h1>
            <p>This is a restricted administrative interface.</p>
            <p>Enter the authorization passcode to continue:</p>

            <div>
                <input type="password" id="passcodeInput" class="passcode-input" placeholder="Enter Passcode" maxlength="50">
                <br>
                <button onclick="authenticate()" class="auth-btn">üîì Authenticate</button>
            </div>
            <div id="errorMsg" class="error-msg"></div>
        </div>

        <!-- Admin Panel (Hidden by default) -->
        <div id="adminPanel" class="admin-panel">
            <div class="admin-header">
                <h1>üëë Administrative Control Panel</h1>
                <p>Manage user privileges and system access</p>
                <button onclick="logout()" class="auth-btn">üö™ Logout</button>
            </div>

            <div id="usersList" class="user-list">
                <p style="text-align: center; color: #bbb;">Loading users...</p>
            </div>

            <!-- Game Multiplier Controls -->
            <div class="admin-section">
                <h3>üéÆ Game Multiplier Controls</h3>
                <div class="multiplier-grid">
                    <div class="multiplier-item">
                        <label>Coinflip Multiplier:</label>
                        <input type="number" id="coinflip-multiplier" min="0.1" max="10" step="0.1" value="2.0">
                        <button onclick="updateMultiplier('coinflip')">Update</button>
                    </div>
                    <div class="multiplier-item">
                        <label>Dice Low/High Multiplier:</label>
                        <input type="number" id="dice-low-multiplier" min="0.1" max="10" step="0.1" value="2.4">
                        <button onclick="updateMultiplier('dice-low')">Update</button>
                    </div>
                    <div class="multiplier-item">
                        <label>Dice Mid Multiplier:</label>
                        <input type="number" id="dice-mid-multiplier" min="0.1" max="10" step="0.1" value="7.2">
                        <button onclick="updateMultiplier('dice-mid')">Update</button>
                    </div>
                    <div class="multiplier-item">
                        <label>Cups Multiplier:</label>
                        <input type="number" id="cups-multiplier" min="0.1" max="10" step="0.1" value="3.0">
                        <button onclick="updateMultiplier('cups')">Update</button>
                    </div>
                </div>
            </div>

            <!-- Taxation Controls -->
            <div class="admin-section">
                <h3>üí∞ Taxation Controls</h3>
                <div class="tax-controls">
                    <p>Tax all users' credits (rounding up):</p>
                    <button onclick="taxAllUsers(1)" class="tax-btn">Tax 1%</button>
                    <button onclick="taxAllUsers(5)" class="tax-btn">Tax 5%</button>
                    <button onclick="taxAllUsers(10)" class="tax-btn">Tax 10%</button>
                </div>
                <div id="taxStatus" class="tax-status"></div>
            </div>

            <!-- Control Panel Actions -->
            <div class="admin-section">
                <h3>üîÑ Panel Controls</h3>
                <div class="panel-controls">
                    <button onclick="refreshPanel()" class="refresh-btn">üîÑ Refresh All Data</button>
                    <button onclick="forceReloadUsers()" class="refresh-btn">üë• Force Reload Users</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Configuration -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getDatabase, ref, get, set, serverTimestamp, push, update } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';

        // Firebase configuration - using correct project config
        const firebaseConfig = {
            apiKey: "AIzaSyAyCOxYlNRn-tveI9G22BHYI8EEpMAEWEI",
            authDomain: "schoolchat-60b44.firebaseapp.com",
            databaseURL: "https://schoolchat-60b44-default-rtdb.firebaseio.com",
            projectId: "schoolchat-60b44",
            storageBucket: "schoolchat-60b44.firebasestorage.app",
            messagingSenderId: "209703349541",
            appId: "1:209703349541:web:d89ba692f5f5c322503ecc",
            measurementId: "G-S6VLMJHKFF"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase();

        // Make Firebase functions globally available
        window.firebaseDb = db;
        window.firebaseRef = ref;
        window.firebaseGet = get;
        window.firebaseSet = set;
        window.firebaseUpdate = update;
        window.firebasePush = push;
        window.firebaseServerTimestamp = serverTimestamp;
    </script>

    <script>
        // Copy protection
        document.addEventListener("contextmenu", function(e) {
            e.preventDefault();
        });

        document.addEventListener("keydown", function(e) {
            if (e.ctrlKey && (e.key === 'u' || e.key === 'U' || e.key === 's' || e.key === 'S')) {
                e.preventDefault();
            }
            if (e.key === 'F12') {
                e.preventDefault();
            }
        });

        // Authentication system
        const CORRECT_PASSCODE = "At7lant7a";
        let isAuthenticated = false;

        function authenticate() {
            const enteredCode = document.getElementById('passcodeInput').value;
            const errorDiv = document.getElementById('errorMsg');

            if (enteredCode === CORRECT_PASSCODE) {
                isAuthenticated = true;
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';

                // Show loading message immediately
                document.getElementById('usersList').innerHTML = '<p style="text-align: center; color: #fff;">üîÑ Connecting to database...</p>';

                // Load users and multipliers with a small delay to ensure DOM is ready
                setTimeout(() => {
                    loadUsers();
                    loadMultipliers();
                }, 500);
                logAccess('SUCCESSFUL_AUTH');
            } else {
                errorDiv.textContent = '‚ùå Invalid passcode. Access denied.';
                logAccess('FAILED_AUTH_ATTEMPT');
                // Clear the input
                document.getElementById('passcodeInput').value = '';
            }
        }

        function logout() {
            isAuthenticated = false;
            document.getElementById('authScreen').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('passcodeInput').value = '';
            document.getElementById('errorMsg').textContent = '';
            logAccess('LOGOUT');
        }

        // Log access attempts for security
        async function logAccess(action) {
            try {
                const securityRef = window.firebaseRef(window.firebaseDb, 'security_logs');
                await window.firebasePush(securityRef, {
                    action: action,
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    ip: 'unknown'
                });
            } catch (error) {
                console.error('Failed to log security event:', error);
            }
        }

        // Load and display users
        async function loadUsers() {
            if (!isAuthenticated) return;

            // Wait for Firebase to be ready
            let attempts = 0;
            while (!window.firebaseDb && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }

            if (!window.firebaseDb) {
                document.getElementById('usersList').innerHTML = '<p style="text-align: center; color: #e74c3c;">Firebase connection failed. Please refresh the page.</p>';
                return;
            }

            try {
                console.log('Loading users from Firebase...');
                const usersRef = window.firebaseRef(window.firebaseDb, 'users');
                const snapshot = await window.firebaseGet(usersRef);

                console.log('Firebase response received:', snapshot.exists());

                if (snapshot.exists()) {
                    const users = snapshot.val();
                    console.log('Users data:', Object.keys(users).length, 'users found');
                    displayUsers(users);
                } else {
                    document.getElementById('usersList').innerHTML = '<p style="text-align: center; color: #bbb;">No users found in database.</p>';
                }
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersList').innerHTML = `<p style="text-align: center; color: #e74c3c;">Error loading users: ${error.message}</p>`;
            }
        }

        function displayUsers(users) {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';

            let validUserCount = 0;

            for (const [username, userData] of Object.entries(users)) {
                // Enhanced filtering for API keys and suspicious entries
                const usernameStr = String(username);
                const isApiKey = usernameStr.length > 20 ||
                    usernameStr.includes('AIza') ||
                    usernameStr.includes('firebase') ||
                    usernameStr.includes('api') ||
                    usernameStr.includes('key') ||
                    (usernameStr.includes('-') && usernameStr.length > 25);

                if (isApiKey) {
                    console.log('Filtered out suspicious entry:', usernameStr.substring(0, 10) + '...');
                    continue;
                }

                // Skip if userData is not a proper object
                if (!userData || typeof userData !== 'object') {
                    continue;
                }

                validUserCount++;

                const userItem = document.createElement('div');
                userItem.className = 'user-item';

                const isAdmin = userData.isAdmin === true || userData.adminVerified === true;

                userItem.innerHTML = `
                    <div class="user-info">
                        <div class="username">${isAdmin ? 'üëë' : 'üë§'} ${usernameStr}</div>
                        <div class="user-stats">Points: ${userData.points || 0} | Joined: ${userData.joinDate || 'Unknown'}</div>
                    </div>
                    <div class="admin-toggle ${isAdmin ? 'active' : ''}" onclick="toggleAdmin('${usernameStr}', ${!isAdmin})">
                        <div class="toggle-slider"></div>
                    </div>
                `;

                usersList.appendChild(userItem);
            }

            if (validUserCount === 0) {
                usersList.innerHTML = '<p style="text-align: center; color: #bbb;">No valid users found.</p>';
            }

            console.log(`Displayed ${validUserCount} valid users`);
        }

        // Toggle admin status with improved error handling and verification
        async function toggleAdmin(username, makeAdmin) {
            if (!isAuthenticated) return;

            const confirmed = confirm(`Are you sure you want to ${makeAdmin ? 'GRANT' : 'REMOVE'} admin privileges ${makeAdmin ? 'to' : 'from'} ${username}?`);
            if (!confirmed) return;

            try {
                const userRef = window.firebaseRef(window.firebaseDb, `users/${username}`);

                // Get current user data to preserve other fields
                const snapshot = await window.firebaseGet(userRef);
                if (!snapshot.exists()) {
                    alert('User not found');
                    return;
                }

                const userData = snapshot.val();

                // Update admin status with explicit boolean values
                const updatedData = {
                    ...userData,
                    isAdmin: makeAdmin === true,
                    adminVerified: makeAdmin === true
                };

                // If removing admin, also remove any admin-only fields
                if (!makeAdmin) {
                    delete updatedData.adminLevel;
                    delete updatedData.adminPrivileges;
                }

                await window.firebaseSet(userRef, updatedData);

                // Verify the change was applied
                const verifySnapshot = await window.firebaseGet(userRef);
                const verifyData = verifySnapshot.val();
                const actualStatus = verifyData.isAdmin === true && verifyData.adminVerified === true;

                // Log the admin change
                const securityRef = window.firebaseRef(window.firebaseDb, 'security_logs');
                await window.firebasePush(securityRef, {
                    action: makeAdmin ? 'ADMIN_GRANTED' : 'ADMIN_REMOVED',
                    target: username,
                    requestedStatus: makeAdmin,
                    actualStatus: actualStatus,
                    timestamp: new Date().toISOString(),
                    source: 'CONTROL_PANEL'
                });

                // Show result to user
                if (actualStatus === makeAdmin) {
                    alert(`‚úÖ Successfully ${makeAdmin ? 'granted admin privileges to' : 'removed admin privileges from'} ${username}`);
                } else {
                    alert(`‚ö†Ô∏è Admin status change may not have been applied correctly. Please check and try again.`);
                }

                // Reload users to update display
                setTimeout(loadUsers, 500);

            } catch (error) {
                console.error('Error updating admin status:', error);
                alert(`Error updating admin status: ${error.message}`);
            }
        }

        // Refresh all panel data
        async function refreshPanel() {
            if (!isAuthenticated) return;

            document.getElementById('usersList').innerHTML = '<p style="text-align: center; color: #fff;">üîÑ Refreshing all data...</p>';

            try {
                await loadUsers();
                await loadMultipliers();
                alert('‚úÖ Panel data refreshed successfully!');
            } catch (error) {
                console.error('Error refreshing panel:', error);
                alert('Error refreshing panel data');
            }
        }

        // Force reload users with cache bust
        async function forceReloadUsers() {
            if (!isAuthenticated) return;

            document.getElementById('usersList').innerHTML = '<p style="text-align: center; color: #fff;">üîÑ Force reloading users...</p>';

            try {
                // Add a small delay to ensure any pending writes are complete
                await new Promise(resolve => setTimeout(resolve, 1000));
                await loadUsers();
                alert('‚úÖ Users reloaded successfully!');
            } catch (error) {
                console.error('Error force reloading users:', error);
                alert('Error reloading users');
            }
        }

        // Load current multipliers when panel loads
        async function loadMultipliers() {
            if (!isAuthenticated) return;

            try {
                const configRef = window.firebaseRef(window.firebaseDb, 'game_config');
                const snapshot = await window.firebaseGet(configRef);

                if (snapshot.exists()) {
                    const config = snapshot.val();
                    if (config.multipliers) {
                        document.getElementById('coinflip-multiplier').value = config.multipliers.coinflip || 2.0;
                        document.getElementById('dice-low-multiplier').value = config.multipliers.diceLow || 2.4;
                        document.getElementById('dice-mid-multiplier').value = config.multipliers.diceMid || 7.2;
                        document.getElementById('cups-multiplier').value = config.multipliers.cups || 3.0;
                    }
                }
            } catch (error) {
                console.error('Error loading multipliers:', error);
            }
        }

        // Update game multipliers
        async function updateMultiplier(gameType) {
            if (!isAuthenticated) return;

            let value, configKey;
            switch(gameType) {
                case 'coinflip':
                    value = parseFloat(document.getElementById('coinflip-multiplier').value);
                    configKey = 'coinflip';
                    break;
                case 'dice-low':
                    value = parseFloat(document.getElementById('dice-low-multiplier').value);
                    configKey = 'diceLow';
                    break;
                case 'dice-mid':
                    value = parseFloat(document.getElementById('dice-mid-multiplier').value);
                    configKey = 'diceMid';
                    break;
                case 'cups':
                    value = parseFloat(document.getElementById('cups-multiplier').value);
                    configKey = 'cups';
                    break;
                default:
                    return;
            }

            // Validate range
            if (value < 0.1 || value > 10) {
                alert('Multiplier must be between 0.1x and 10x');
                return;
            }

            try {
                const configRef = window.firebaseRef(window.firebaseDb, `game_config/multipliers/${configKey}`);
                await window.firebaseSet(configRef, value);

                // Log the change
                const securityRef = window.firebaseRef(window.firebaseDb, 'security_logs');
                await window.firebasePush(securityRef, {
                    action: 'MULTIPLIER_UPDATED',
                    game: gameType,
                    newValue: value,
                    timestamp: new Date().toISOString(),
                    source: 'CONTROL_PANEL'
                });

                alert(`${gameType} multiplier updated to ${value}x`);
            } catch (error) {
                console.error('Error updating multiplier:', error);
                alert('Error updating multiplier');
            }
        }

        // Tax all users
        async function taxAllUsers(percentage) {
            if (!isAuthenticated) return;

            const confirmed = confirm(`Are you sure you want to tax ALL users ${percentage}% of their credits? This action cannot be undone.`);
            if (!confirmed) return;

            const statusDiv = document.getElementById('taxStatus');
            statusDiv.innerHTML = `üîÑ Processing ${percentage}% tax on all users...`;
            statusDiv.className = 'tax-status';

            try {
                const usersRef = window.firebaseRef(window.firebaseDb, 'users');
                const snapshot = await window.firebaseGet(usersRef);

                if (!snapshot.exists()) {
                    statusDiv.innerHTML = '‚ùå No users found to tax';
                    statusDiv.className = 'tax-status error';
                    return;
                }

                const users = snapshot.val();
                let taxedUsers = 0;
                let totalTaxCollected = 0;

                for (const [username, userData] of Object.entries(users)) {
                    // Skip API keys and invalid entries
                    const usernameStr = String(username);
                    const isApiKey = usernameStr.length > 20 ||
                        usernameStr.includes('AIza') ||
                        usernameStr.includes('firebase') ||
                        usernameStr.includes('api') ||
                        usernameStr.includes('key') ||
                        (usernameStr.includes('-') && usernameStr.length > 25);

                    if (isApiKey || !userData || typeof userData !== 'object') {
                        continue;
                    }

                    const currentPoints = userData.points || 0;
                    if (currentPoints <= 0) continue;

                    // Calculate tax amount and round UP
                    const taxAmount = Math.ceil(currentPoints * (percentage / 100));
                    const newPoints = Math.max(0, currentPoints - taxAmount);

                    // Update user points
                    const userRef = window.firebaseRef(window.firebaseDb, `users/${username}`);
                    await window.firebaseUpdate(userRef, { points: newPoints });

                    taxedUsers++;
                    totalTaxCollected += taxAmount;
                }

                // Log the taxation event
                const securityRef = window.firebaseRef(window.firebaseDb, 'security_logs');
                await window.firebasePush(securityRef, {
                    action: 'MASS_TAXATION',
                    percentage: percentage,
                    usersAffected: taxedUsers,
                    totalTaxCollected: totalTaxCollected,
                    timestamp: new Date().toISOString(),
                    source: 'CONTROL_PANEL'
                });

                statusDiv.innerHTML = `‚úÖ Successfully taxed ${taxedUsers} users ${percentage}%. Total collected: ${totalTaxCollected} credits.`;
                statusDiv.className = 'tax-status success';

                // Reload users to show updated points
                setTimeout(loadUsers, 1000);

            } catch (error) {
                console.error('Error during taxation:', error);
                statusDiv.innerHTML = `‚ùå Error during taxation: ${error.message}`;
                statusDiv.className = 'tax-status error';
            }
        }

        // Allow Enter key for authentication
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('passcodeInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    authenticate();
                }
            });
        });

        // Security: Require re-authentication every 30 minutes
        setTimeout(() => {
            if (isAuthenticated) {
                logout();
                alert('Session expired. Please re-authenticate.');
            }
        }, 30 * 60 * 1000);
    </script>
</body>
</html>